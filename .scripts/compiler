#!/bin/bash

file=$(readlink -f "$1")
dir=$(dirname "$file")
base="${file%.*}"

cd "$dir" || exit

args="${@:2}"

get_root() {
    grep -q '% !TeX root = ' "$file" || return
    root_file=$(sed -n 's/^% !TeX root = \(.\+\)$/\1/p' "$file")
    file=$(readlink -f "$root_file")
    cd "$(dirname "$file")"
}

case "$file" in
    *\.cpp) g++ -g -O0 -Wall -Wextra -pedantic -o "$base" "$file" ;;
    *\.ms) groff -ms "$file" $args -T pdf > "$base".pdf ;;
    *\.py) python3 "$1" $args ;;
    *\.md) pandoc "$file" --pdf-engine=xelatex $args -o "$base".pdf ;;
    *\.tex) get_root ; xelatex $args "$file" ;;
    *\.go) go run "$file" $args ;;
    *\.html) $BROWSER "$file" ;;
    *\.Xresources) xrdb -merge "$file" ;;
    *config\.h) make && sudo make install ;;
    *) sed 1q "$file" | grep "^#!/" | sed "s/^#!//" | xargs -r -I % "$file" $args ;;
esac

# beamer: -t beamer
# svg pics: --shell-escape
