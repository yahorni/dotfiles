#!/bin/bash

OPTIND=1

outvideo="$(xdg-user-dir VIDEOS)"
outaudio="$(xdg-user-dir MUSIC)"
filename='%(title)s.%(ext)s'
format="m"

print_help() {
    echo "Usage: ytloader [options] link"
    echo "Description: downloads music and video from youtube"
    echo "    -h - show help and exit"
    echo "    -f - format."
    echo "         'a' - audio"
    echo "         'l' - low quality video (up to 240p)"
    echo "         'm' - medium quality video (up to 1080p)"
    echo "         'h' - high quality video (best quality available)"
    echo "    -s - download video with subtitles (if available)"
    echo "    -d - subdirectory for file. Appends to default music/video path"
    echo "    -u - add uploader at the title"
}

while getopts "f:d:suh" opt; do
    case $opt in
        f) format=$OPTARG ;;
        d) subdir=$OPTARG ;;
        s) with_subs="--all-subs" ;;
        u) filename='%(uploader)s - %(title)s.%(ext)s' ;;
        h) print_help ; exit 0 ;;
    esac
done

shift $(($OPTIND-1))
link=$1

[ -z "$link" ] && echo -e "Error: No URL to download given\n" && print_help && exit

if [ -z "$subdir" ]; then
    outaudio="${outaudio}/downloads"
else
    outvideo="${outvideo}/${subdir}"
    outaudio="${outaudio}/${subdir}"
fi

[ ! -d "$outaudio" ] && mkdir -p "$outaudio"
[ ! -d "$outvideo" ] && mkdir -p "$outvideo"

notify-send "Downloading" "$link"

case $format in
    'a') youtube-dl --add-metadata -icxf "bestaudio/best" -o "$outaudio/$filename" "$link" ;;
    'l') youtube-dl --add-metadata $with_subs -icf "best[height<=240]" -o "$outvideo/$filename" "$link" ;;
    'm') youtube-dl --add-metadata $with_subs -icf "bestvideo[height<=1080]+bestaudio/best" -o "$outvideo/$filename" "$link" ;;
    'h') youtube-dl --add-metadata $with_subs -icf "bestvideo+bestaudio/best" -o "$outvideo/$filename" "$link" ;;
    *) echo "Incorrect format"
esac

notify-send "Loaded" "$link"
